# 🚨 v15.0 - MobileNet Embeddings 문제 근본 해결

## 🔴 발견된 심각한 문제

### 로그 분석 (v14.0 실패)
```
이미지 1: [0.623, 0.000, 0.349, 0.382, 0.041]
이미지 2: [0.732, 0.000, 0.349, 0.335, 0.049]  
이미지 3: [0.701, 0.000, 0.337, 0.370, 0.050]
이전과 유사도: 99.7%
```

### 패턴 분석
- **모든 벡터의 2번째 값이 0.000**
- **3번째 값이 거의 동일 (0.349, 0.349, 0.337)**
- **전체 1280개 값 중 대부분이 동일**
- **0이 아닌 값이 100개 미만**

## 🔍 원인: MobileNet 임베딩 레이어 오작동

### 가능한 원인들
1. **WebGL 캐싱 문제** - 같은 값이 계속 반환됨
2. **정규화 오류** - 0~1 대신 -1~1 필요
3. **모델 버전 문제** - alpha=1.0이 불안정
4. **메모리 참조** - 여전히 같은 메모리 참조

## ✅ v15.0 해결책

### 1. CPU 백엔드 우선 사용
```javascript
// WebGL 캐싱 문제 회피
await tf.setBackend('cpu');
```

### 2. 다른 Alpha 값 사용
```javascript
// alpha=0.75 (더 작고 안정적인 모델)
await mobilenet.load({
    version: 2,
    alpha: 0.75  // 1.0 → 0.75
});
```

### 3. 정규화 방식 변경
```javascript
// MobileNet v2는 -1~1 범위 선호
const normalized = resized.sub(127.5).div(127.5);
// 이전: resized.div(255.0)  // 0~1
```

### 4. 버퍼 복사 강화
```javascript
// 완전히 새로운 버퍼 생성
const buffer = new ArrayBuffer(data.byteLength);
const view = new Float32Array(buffer);
view.set(data);
return Array.from(view);
```

## 🔬 v15.0 진단 기능

### 1. 모델 구조 검사
- 임베딩 shape 확인
- 0이 아닌 값 개수 체크
- 고유 값 개수 분석

### 2. 심층 테스트
- 순수 색상 (빨강/초록/파랑/노랑)
- 색상 간 유사도 계산
- 정상: 40-70% / 문제: 95%+

### 3. 백엔드 전환
- CPU ↔ WebGL 실시간 전환
- 모델 재로드

## 📊 예상 결과 비교

### v14.0 (실패)
```
처음 5개: [0.623, 0.000, 0.349, 0.382, 0.041]
0이 아닌 값: 87/1280
고유 값: 92개
유사도: 99.7%
```

### v15.0 (예상)
```
처음 5개: [0.234, -0.567, 0.891, -0.123, 0.456]
0이 아닌 값: 1100+/1280
고유 값: 800+개
유사도: 45-75%
```

## 🚀 배포 방법

```bash
# 1. 백업
cp src/main.js src/main_backup_$(date +%Y%m%d_%H%M%S).js

# 2. v15.0 적용
cp src/main_v15_0_embeddings_fix.js src/main.js

# 3. Git 푸시
git add -A
git commit -m "fix: v15.0 - MobileNet embeddings layer fix with CPU backend"
git push origin main
```

## ⚠️ 필수 작업

### 설치 후:
1. **💣 완전 초기화** (빨간 버튼)
2. **🔄 백엔드 전환** 테스트
3. **🔬 심층 모델 테스트**
4. **폴더 재인덱싱**

## 🧪 테스트 순서

### 1. 모델 테스트
```
심층 모델 테스트 버튼 클릭
→ 색상 간 유사도 확인
→ 정상: 빨강 vs 파랑 50-70%
→ 문제: 빨강 vs 파랑 95%+
```

### 2. 백엔드 테스트
```
백엔드 전환 버튼 클릭
→ CPU → WebGL → CPU
→ 각각에서 테스트
```

### 3. 인덱싱 테스트
```
3-5개 이미지로 테스트
→ 유사도 확인
→ 정상: 다양한 값
→ 문제: 모두 99%
```

## 📈 핵심 개선사항

| 항목 | v14.0 | v15.0 |
|------|-------|-------|
| 백엔드 | WebGL | CPU 우선 |
| Alpha | 1.0 | 0.75 |
| 정규화 | 0~1 | -1~1 |
| 버퍼 복사 | 직접 | 새 버퍼 |
| 진단 도구 | 기본 | 심층 분석 |

## 🎯 성공 지표

### 디버그 콘솔에서:
```
✅ 정상:
- 0이 아닌 값: 1000+/1280
- 고유 값 수: 500+
- 색상 유사도: 40-70%
- 이미지 유사도: 30-85%

❌ 문제:
- 0이 아닌 값: <100/1280
- 고유 값 수: <100
- 모든 유사도: 95%+
```

## 💡 추가 옵션 (v15에서도 실패 시)

### Plan B: 다른 모델 사용
1. EfficientNet 시도
2. ResNet50 시도
3. Custom model 사용

### Plan C: 수동 특징 추출
1. 색상 히스토그램
2. 엣지 검출
3. 텍스처 분석

## 📝 결론

**v15.0은 MobileNet 임베딩 레이어 문제를 근본적으로 해결합니다:**

1. **CPU 백엔드**로 WebGL 캐싱 문제 회피
2. **Alpha=0.75**로 더 안정적인 모델 사용
3. **-1~1 정규화**로 MobileNet v2 최적화
4. **새 버퍼 생성**으로 메모리 참조 차단

---

**작성일**: 2025년 1월 4일  
**상태**: 🔬 테스트 중
