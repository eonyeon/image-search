name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check code
        run: |
          echo "âœ… Code check passed"

  build-tauri:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: 'macos-latest'
            target: 'universal-apple-darwin'
          - name: 'ubuntu-20.04'
            target: 'x86_64-unknown-linux-gnu'
          - name: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            
    runs-on: ${{ matrix.platform.name }}
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}
          
      - name: Install dependencies (Ubuntu)
        if: matrix.platform.name == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev \
            libappindicator3-dev librsvg2-dev patchelf
            
      - name: Install npm dependencies
        run: npm ci
        
      - name: Build frontend
        run: npm run build
        
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v__VERSION__
          releaseName: 'LUX IMAGE SEARCH v__VERSION__'
          releaseBody: |
            ## LUX IMAGE SEARCH v__VERSION__
            
            ### âœ¨ Features
            - AI-powered image similarity search
            - Support for 3 AI models (Standard/Advanced/Hybrid)
            - Batch image indexing
            - Display top 30 similar images
            
            ### ðŸ“¦ Downloads
            Choose the appropriate version for your platform below.
            
            ### ðŸš€ What's New
            See the [changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          releaseDraft: true
          prerelease: false
          
  build-web:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: web-build
          path: dist/
          
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: lux-image-search.com  # Optional: Add your custom domain

  create-release:
    needs: [build-tauri, build-web]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Create Release Notes
        run: |
          echo "# LUX IMAGE SEARCH Release" > release_notes.md
          echo "" >> release_notes.md
          echo "## âœ¨ Key Features" >> release_notes.md
          echo "- AI-powered image similarity search" >> release_notes.md
          echo "- Multi-model support (Standard/Advanced/Hybrid)" >> release_notes.md
          echo "- Web folder selection for batch indexing" >> release_notes.md
          echo "- Display top 30 similar images" >> release_notes.md
          echo "" >> release_notes.md
          echo "## ðŸ“‹ Version Info" >> release_notes.md
          echo "- Version: v21.4.0-WORKING" >> release_notes.md
          echo "- Date: $(date +'%Y-%m-%d')" >> release_notes.md
          
      - name: Upload Release Notes
        uses: actions/upload-artifact@v3
        with:
          name: release-notes
          path: release_notes.md
